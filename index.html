<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«å¿ƒéšœç¤™ç‰™ç§‘æ²»ç™‚ä»£ç¢¼æŸ¥è©¢</title>
	<link rel="icon" type="image/png" href="charity_2770179.png">
    
    <style>
        /* ä¿ç•™æ‚¨åŸæœ¬çš„æ‰€æœ‰æ¨£å¼ */
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif; padding: 20px; background-color: #f4f7f6; max-width: 800px; margin: 0 auto; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h3 { color: #34495e; margin-top: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #34495e; }
        select, button { padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; background-color: white; font-size: 16px; }
        select:disabled, button:disabled { background-color: #ecf0f1; color: #bdc3c7; }
        button { background-color: #3498db; color: white; cursor: pointer; border: none; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        #results { margin-top: 20px; padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #code_list_results > div { padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .result-table th { background-color: #eaf2f8; color: #34495e; font-weight: bold; width: 30%; }
        .no-result { color: #e74c3c; font-weight: bold; padding: 10px 0;}
        a { text-decoration: none; color: #1a5276; font-weight: bold; transition: color 0.3s; }
        a:hover { text-decoration: underline; color: #2980b9; }
        .desktop-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .desktop-table th, .desktop-table td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; font-size: 14px; }
        .desktop-table th { background-color: #3498db; color: white; }
        .mobile-card-list { display: none; padding: 0; list-style: none; }
        .mobile-card { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 10px; border-radius: 6px; background-color: #f9f9f9; }
        .mobile-card h4 { margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #eaf2f8; padding-bottom: 5px; font-size: 14px; font-weight: bold; }
        .mobile-field-row { display: flex; margin-bottom: 5px; line-height: 1.4; }
        .mobile-field-title { font-weight: normal; color: #7f8c8d; min-width: 90px; margin-right: 5px; }
        .mobile-field-content { font-weight: bold; color: #2c3e50; flex-grow: 1; }
        @media (max-width: 600px) { .desktop-table { display: none; } .mobile-card-list { display: block; } }
    </style>
</head>
<body>
    <h1>ğŸ¦· èº«å¿ƒéšœç¤™ç‰™ç§‘ä»£ç¢¼æŸ¥è©¢</h1>

    <label for="a_category">1. é¸æ“‡ä¸»è¦åˆ†é¡ï¼š</label>
    <select id="a_category" onchange="aCategoryChanged(this.value)">
        <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
    </select>
    
    <label for="b_category">2. é¸æ“‡éšœç¤™é¡åˆ¥ï¼š</label>
    <select id="b_category" onchange="bCategoryChanged(this.value)" disabled>
        <option value="" disabled selected>è«‹å…ˆé¸æ“‡ä¸»è¦åˆ†é¡</option>
    </select>

    <label for="level">3. é¸æ“‡éšœç¤™ç­‰ç´šï¼š</label>
    <select id="level" disabled>
        <option value="" disabled selected>è«‹å…ˆé¸æ“‡éšœç¤™é¡åˆ¥</option>
    </select>

    <br>
    <button id="query_button" onclick="executeQuery()" disabled>æŸ¥è©¢ç”³å ±ä»£ç¢¼</button>
    
    <hr>
    <h2>âœ… æŸ¥è©¢çµæœ</h2>
    <div id="results">è«‹åœ¨ä¸Šæ–¹é¸æ“‡æŸ¥è©¢æ¢ä»¶å¾Œé»æ“ŠæŸ¥è©¢ã€‚</div>
    
    <div style="margin-top: 25px;">
        <button id="show_code_button" onclick="showCodeList()">æŸ¥çœ‹16æ¡ˆä»¶å¥ä¿ç”³å ±ä»£ç¢¼</button>
    </div>
    <div id="code_list_results" style="display: none; padding: 0;"></div>
    
    <hr style="margin-top: 30px;">
    
    <div style="margin-top: 30px; padding: 15px; border-top: 1px solid #ddd;">
        <p style="font-weight: bold; color: #e74c3c;">æ³¨æ„ï¼šæœ¬åŠŸèƒ½åƒ…ä¾›åƒè€ƒï¼Œè«‹è‡ªè¡ŒæŸ¥è­‰æ­£ç¢ºæ€§ã€‚</p>
        <h3 style="color: #34495e; margin-top: 20px;">åƒè€ƒè³‡æ–™ï¼š</h3>
        <ul style="list-style-type: disc; padding-left: 20px;">
            <li style="margin-bottom: 8px;"><a href="https://www.cda.org.tw/cda/journal_list.jsp?cid=211" target="_blank" rel="noopener noreferrer">2025ç‰™é†«å…¨è¯æœƒå¯¦ç”¨æ‰‹å†Šp150åŠå…¶ä»–</a></li>
            <li style="margin-bottom: 8px;"><a href="https://www.cda.org.tw/cda/news_detail.jsp?nid=987" target="_blank" rel="noopener noreferrer">114 å¹´åº¦å…¨æ°‘å¥åº·ä¿éšªç‰™é†«é–€è¨ºç¸½é¡ç‰¹æ®Šé†«ç™‚æœå‹™è¨ˆç•«</a></li>
        </ul>
    </div>

    <script>
        // âš ï¸ è«‹å¡«å¯«æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€
        const API_URL = 'https://script.google.com/macros/s/AKfycbyAU0S9L3LAjxjC3Ops-P8FRUYtx7dqZaBF-uqqTYh6itSvXrKVlQXhb9vFdCnx7ORJjQ/exec';

        // é é¢è¼‰å…¥å¾Œè‡ªå‹•å–å¾—ç¬¬ä¸€å±¤é¸å–®
        window.onload = function() {
            callApi('getAOptions', {}, (data) => {
                updateSelectOptions('a_category', data, 'è«‹é¸æ“‡ä¸»è¦åˆ†é¡');
            });
        };

        // é€šç”¨çš„ API å‘¼å«å‡½æ•¸ï¼Œå–ä»£ google.script.run
        function callApi(action, params, callback) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }
            fetch(url)
                .then(response => response.json())
                .then(data => callback(data))
                .catch(err => {
                    console.error('API éŒ¯èª¤:', err);
                    alert('ç„¡æ³•é€£ç·šè‡³å¾Œç«¯æœå‹™ï¼Œè«‹æª¢æŸ¥ API ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚');
                });
        }

        function processLineBreaks(value) {
            if (!value) return '';
            return String(value).replace(/\s*\[BR\]\s*/gi, '<br>').trim();
        }

        function processRawValue(value) {
            if (!value) return '';
            return String(value).trim();
        }
        
        function updateSelectOptions(selectId, options, placeholder) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            if (options && Array.isArray(options)) {
                options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = o.text = opt;
                    select.appendChild(o);
                });
                select.disabled = false;
            }
        }

        function resetSelect(selectId, placeholder) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            select.disabled = true;
        }

        function resetQueryState() {
            document.getElementById('query_button').disabled = true;
            document.getElementById('results').innerHTML = 'è«‹åœ¨ä¸Šæ–¹é¸æ“‡æŸ¥è©¢æ¢ä»¶å¾Œé»æ“ŠæŸ¥è©¢ã€‚';
        }

        function aCategoryChanged(val) {
            resetSelect('b_category', 'è¼‰å…¥ä¸­...');
            resetSelect('level', 'è«‹å…ˆé¸æ“‡éšœç¤™é¡åˆ¥');
            resetQueryState();
            if (val) callApi('getBOptions', { aSelection: val }, (data) => {
                updateSelectOptions('b_category', data, 'è«‹é¸æ“‡éšœç¤™é¡åˆ¥');
            });
        }

        function bCategoryChanged(val) {
            resetSelect('level', 'è¼‰å…¥ä¸­...');
            resetQueryState();
            const a = document.getElementById('a_category').value;
            if (val) callApi('getLevelOptions', { aSelection: a, bSelection: val }, (data) => {
                const levelSelect = document.getElementById('level');
                updateSelectOptions('level', data, 'è«‹é¸æ“‡éšœç¤™ç­‰ç´š');
                levelSelect.onchange = enableQueryButton;
                // è‡ªå‹•é¸å–é‚è¼¯
                if (data && data.length === 1) {
                    levelSelect.selectedIndex = 1;
                    enableQueryButton();
                }
            });
        }

        function enableQueryButton() {
            document.getElementById('query_button').disabled = false;
        }

        function executeQuery() {
            const a = document.getElementById('a_category').value;
            const b = document.getElementById('b_category').value;
            const l = document.getElementById('level').value;
            if (a && b && l) {
                document.getElementById('query_button').disabled = true;
                document.getElementById('results').innerHTML = '<p style="color: #3498db; font-weight: bold;">æŸ¥è©¢ä¸­... è«‹ç¨å€™...</p>';
                callApi('queryCode', { a, b, l }, displayResults);
            }
        }

        function displayResults(response) {
            document.getElementById('query_button').disabled = false;
            const resultsDiv = document.getElementById('results');
            if (!response.results || response.results.length === 0) {
                resultsDiv.innerHTML = '<p class="no-result">âš ï¸ æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„ç”³å ±ä»£ç¢¼æˆ–è³‡æ–™ã€‚</p>';
                return;
            }
            const headers = response.headers;
            let html = '';
            response.results.forEach(row => {
                html += '<table class="result-table">';
                headers.forEach((h, i) => {
                    if (i >= 3 && row[i] !== '') {
                        const val = h.includes('å‚™è¨»') ? processLineBreaks(row[i]) : processRawValue(row[i]);
                        html += `<tr><th>${h}</th><td>${val}</td></tr>`;
                    }
                });
                html += '</table><br>';
            });
            resultsDiv.innerHTML = html;
        }

        function showCodeList() {
            const btn = document.getElementById('show_code_button');
            const res = document.getElementById('code_list_results');
            if (res.style.display === 'block' && res.innerHTML !== 'è¼‰å…¥ä¸­...') {
                res.style.display = 'none';
                btn.textContent = 'æŸ¥çœ‹16æ¡ˆä»¶å¥ä¿ç”³å ±ä»£ç¢¼';
                return;
            }
            res.style.display = 'block';
            res.innerHTML = '<p style="color: #3498db; font-weight: bold;">è³‡æ–™è¼‰å…¥ä¸­...</p>';
            callApi('getCodeList', {}, (data) => {
                btn.textContent = 'éš±è—16æ¡ˆä»¶å¥ä¿ç”³å ±ä»£ç¢¼';
                let html = '<div><p style="font-weight: bold; color: #16a085; margin-bottom: 15px;">æœªæ¶µè“‹é …ç›®äº¦å¯ç”³å ±ï¼Œä½†è«‹æ³¨æ„èº«ä»½æ˜¯å¦ç¬¦åˆ</p>';
                html += renderTable(data.headers, data.results);
                html += renderCardList(data.headers, data.results);
                html += '</div>';
                res.innerHTML = html;
            });
        }

        function renderTable(headers, rows) {
            let h = '<table class="desktop-table"><thead><tr>';
            headers.forEach(txt => h += `<th>${txt}</th>`);
            h += '</tr></thead><tbody>';
            rows.forEach(row => {
                h += '<tr>';
                row.forEach((cell, i) => {
                    const val = headers[i].includes('å‚™è¨»') ? processLineBreaks(cell) : processRawValue(cell);
                    h += `<td>${val}</td>`;
                });
                h += '</tr>';
            });
            return h + '</tbody></table>';
        }

        function renderCardList(headers, rows) {
            let h = '<ul class="mobile-card-list">';
            rows.forEach((row, idx) => {
                const title = processRawValue(row[0]) || `é …ç›® ${idx + 1}`;
                h += `<li class="mobile-card"><h4>${title}</h4>`;
                for (let i = 1; i < headers.length; i++) {
                    const val = headers[i].includes('å‚™è¨»') ? processLineBreaks(row[i]) : processRawValue(row[i]);
                    if (val) h += `<div class="mobile-field-row"><span class="mobile-field-title">${headers[i]}:</span><div class="mobile-field-content">${val}</div></div>`;
                }
                h += '</li>';
            });
            return h + '</ul>';
        }
    </script>
</body>
</html>