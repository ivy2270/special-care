<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«å¿ƒéšœç¤™ç‰™ç§‘æ²»ç™‚ä»£ç¢¼æŸ¥è©¢</title>
	<link rel="icon" type="image/png" href="charity_2770179.png">
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif; padding: 20px; background-color: #f4f7f6; max-width: 800px; margin: 0 auto; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h3 { color: #34495e; margin-top: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #34495e; }
        select, button { padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; background-color: white; font-size: 16px; }
        select:disabled, button:disabled { background-color: #ecf0f1; color: #bdc3c7; }
        button { background-color: #3498db; color: white; cursor: pointer; border: none; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        #results { margin-top: 20px; padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #code_list_results > div { padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .result-table th { background-color: #eaf2f8; color: #34495e; font-weight: bold; width: 30%; }
        .no-result { color: #e74c3c; font-weight: bold; padding: 10px 0;}
        a { text-decoration: none; color: #1a5276; font-weight: bold; transition: color 0.3s; }
        a:hover { text-decoration: underline; color: #2980b9; }
        .desktop-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .desktop-table th, .desktop-table td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; font-size: 14px; }
        .desktop-table th { background-color: #3498db; color: white; }
        .mobile-card-list { display: none; padding: 0; list-style: none; }
        .mobile-card { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 10px; border-radius: 6px; background-color: #f9f9f9; }
        .mobile-card h4 { margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #eaf2f8; padding-bottom: 5px; font-size: 14px; font-weight: bold; }
        .mobile-field-row { display: flex; margin-bottom: 5px; line-height: 1.4; }
        .mobile-field-title { font-weight: normal; color: #7f8c8d; min-width: 90px; margin-right: 5px; }
        .mobile-field-content { font-weight: bold; color: #2c3e50; flex-grow: 1; }
        @media (max-width: 600px) { .desktop-table { display: none; } .mobile-card-list { display: block; } }

        /* å³ä¸‹è§’æ›´æ–°æŒ‰éˆ• */
        .refresh-data {
            position: fixed; bottom: 20px; right: 20px; width: auto; font-size: 12px;
            padding: 8px 12px; background: #95a5a6; opacity: 0.7; z-index: 100;
        }
    </style>
</head>
<body>
    <h1>ğŸ¦· èº«å¿ƒéšœç¤™ç‰™ç§‘ä»£ç¢¼æŸ¥è©¢</h1>

    <label for="a_category">1. é¸æ“‡ä¸»è¦åˆ†é¡ï¼š</label>
    <select id="a_category" onchange="aCategoryChanged(this.value)">
        <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
    </select>
    
    <label for="b_category">2. é¸æ“‡éšœç¤™é¡åˆ¥ï¼š</label>
    <select id="b_category" onchange="bCategoryChanged(this.value)" disabled>
        <option value="" disabled selected>è«‹å…ˆé¸æ“‡ä¸»è¦åˆ†é¡</option>
    </select>

    <label for="level">3. é¸æ“‡éšœç¤™ç­‰ç´šï¼š</label>
    <select id="level" disabled>
        <option value="" disabled selected>è«‹å…ˆé¸æ“‡éšœç¤™é¡åˆ¥</option>
    </select>

    <br>
    <button id="query_button" onclick="executeQuery()" disabled>æŸ¥è©¢ç”³å ±ä»£ç¢¼</button>
    
    <hr>
    <h2>âœ… æŸ¥è©¢çµæœ</h2>
    <div id="results">è«‹åœ¨ä¸Šæ–¹é¸æ“‡æŸ¥è©¢æ¢ä»¶å¾Œé»æ“ŠæŸ¥è©¢ã€‚</div>
    
    <div style="margin-top: 25px;">
        <button id="show_code_button" onclick="showCodeList()">æŸ¥çœ‹16æ¡ˆä»¶å¥ä¿ç”³å ±ä»£ç¢¼</button>
    </div>
    <div id="code_list_results" style="display: none; padding: 0;"></div>
    
    <button class="refresh-data" onclick="clearAppData()">ğŸ”„ æ¸…é™¤å¿«å–ä¸¦æ›´æ–°è³‡æ–™</button>

    <hr style="margin-top: 30px;">
    
    <div style="margin-top: 30px; padding: 15px; border-top: 1px solid #ddd;">
        <p style="font-weight: bold; color: #e74c3c;">æ³¨æ„ï¼šæœ¬åŠŸèƒ½åƒ…ä¾›åƒè€ƒï¼Œè«‹è‡ªè¡ŒæŸ¥è­‰æ­£ç¢ºæ€§ã€‚</p>
        <h3 style="color: #34495e; margin-top: 20px;">åƒè€ƒè³‡æ–™ï¼š</h3>
        <ul style="list-style-type: disc; padding-left: 20px;">
            <li style="margin-bottom: 8px;"><a href="https://www.cda.org.tw/cda/journal_list.jsp?cid=211" target="_blank" rel="noopener noreferrer">2025ç‰™é†«å…¨è¯æœƒå¯¦ç”¨æ‰‹å†Šp150åŠå…¶ä»–</a></li>
            <li style="margin-bottom: 8px;"><a href="https://www.cda.org.tw/cda/news_detail.jsp?nid=987" target="_blank" rel="noopener noreferrer">114 å¹´åº¦å…¨æ°‘å¥åº·ä¿éšªç‰™é†«é–€è¨ºç¸½é¡ç‰¹æ®Šé†«ç™‚æœå‹™è¨ˆç•«</a></li>
        </ul>
    </div>

    <script>
        // âš ï¸ è«‹å¡«å¯«æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€
        const API_URL = 'https://script.google.com/macros/s/AKfycbyU6dQSElw84HUCbWJ6AyZBVBNFIz8N5r4k6Wc3jFLx2JIlg2GMs8aSkhjl20POoTDiww/exec';
        
        // å…¨åŸŸè®Šæ•¸å­˜æ”¾
        let APP_DATA = { main: [], codeList: { headers: [], results: [] } };
        const CACHE_KEY = 'dental_app_full_cache';
        const EXPIRE_TIME = 24 * 60 * 60 * 1000; // 24å°æ™‚
        
        // é‚è¼¯å¸¸æ•¸ (éœ€èˆ‡ GS åŒæ­¥)
        const COMMON_CATEGORY = "å…±é€šé …ç›®";
        const EXCLUDE_B_COMMON = ["ç™¼å±•é²ç·©å…’ç«¥", "å¤±èƒ½è€äºº"];
        const LEVEL_ORDER = ['è¼•åº¦', 'ä¸­åº¦', 'é‡åº¦', 'æ¥µé‡åº¦', 'ç™¼å±•é²ç·©å…’ç«¥', 'å¤±èƒ½è€äºº'];

        window.onload = function() {
            initApp();
        };

        // åˆå§‹åŒ–ï¼šå…ˆæª¢æŸ¥å¿«å–ï¼Œå¦å‰‡å¾ç¶²è·¯æŠ“å–
        function initApp() {
            const cached = localStorage.getItem(CACHE_KEY);
            const now = Date.now();

            if (cached) {
                const cacheData = JSON.parse(cached);
                if (now - cacheData.timestamp < EXPIRE_TIME) {
                    console.log("å¾å¿«å–å•Ÿå‹•ç³»çµ±");
                    APP_DATA = cacheData.data;
                    initASelection();
                    return;
                }
            }

            console.log("å¿«å–éæœŸæˆ–ä¸å­˜åœ¨ï¼Œå¾ç¶²è·¯æŠ“å–...");
            fetch(`${API_URL}?action=getMainData`)
                .then(res => res.json())
                .then(data => {
                    APP_DATA = data;
                    localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: now, data: data }));
                    initASelection();
                })
                .catch(err => alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"));
        }

        // 1. åˆå§‹åŒ– A é¸é … (ä¸é‡è¤‡ï¼Œæ’é™¤å…±é€šé …ç›®)
        function initASelection() {
            const rows = APP_DATA.main.slice(1);
            const uniqueA = [...new Set(rows
                .map(r => r[0])
                .filter(a => a && a !== COMMON_CATEGORY)
            )];
            updateSelectOptions('a_category', uniqueA, 'è«‹é¸æ“‡ä¸»è¦åˆ†é¡');
        }

        // 2. ç•¶ A æ”¹è®Šæ™‚ï¼Œå‰ç«¯è¨ˆç®— B (æ¥µé€Ÿ)
        function aCategoryChanged(aSelection) {
            resetSelect('b_category', 'è«‹é¸æ“‡éšœç¤™é¡åˆ¥');
            resetSelect('level', 'è«‹å…ˆé¸æ“‡éšœç¤™é¡åˆ¥');
            resetQueryState();

            const rows = APP_DATA.main.slice(1);
            const uniqueB = new Set();
            const shouldExcludeCommon = EXCLUDE_B_COMMON.includes(aSelection);

            rows.forEach(row => {
                if (row[0] === aSelection && row[1]) uniqueB.add(row[1].trim());
                if (!shouldExcludeCommon && row[0] === COMMON_CATEGORY && row[1]) uniqueB.add(row[1].trim());
            });

            updateSelectOptions('b_category', Array.from(uniqueB).sort(), 'è«‹é¸æ“‡éšœç¤™é¡åˆ¥');
        }

        // 3. ç•¶ B æ”¹è®Šæ™‚ï¼Œå‰ç«¯è¨ˆç®— Level (æ¥µé€Ÿ)
        function bCategoryChanged(bSelection) {
            resetSelect('level', 'è«‹é¸æ“‡éšœç¤™ç­‰ç´š');
            resetQueryState();

            const aSelection = document.getElementById('a_category').value;
            const rows = APP_DATA.main.slice(1);
            
            const isSpecialB = bSelection.includes("13") || bSelection.includes("15") || bSelection.includes("16");
            const effA = (isSpecialB && !EXCLUDE_B_COMMON.includes(aSelection)) ? COMMON_CATEGORY : aSelection;

            const foundLevels = [...new Set(rows
                .filter(r => r[0] === effA && r[1] === bSelection && r[2])
                .map(r => r[2].trim())
            )];

            const sortedLevels = LEVEL_ORDER.filter(l => foundLevels.includes(l));
            const levelSelect = document.getElementById('level');
            updateSelectOptions('level', sortedLevels, 'è«‹é¸æ“‡éšœç¤™ç­‰ç´š');
            
            levelSelect.onchange = enableQueryButton;
            if (sortedLevels.length === 1) {
                levelSelect.selectedIndex = 1;
                enableQueryButton();
            }
        }

        // 4. åŸ·è¡ŒæŸ¥è©¢ (å¾è¨˜æ†¶é«”ç›´æ¥éæ¿¾)
        function executeQuery() {
            const a = document.getElementById('a_category').value;
            const b = document.getElementById('b_category').value;
            const l = document.getElementById('level').value;

            const isSpecialB = b.includes("13") || b.includes("15") || b.includes("16");
            const effA = (isSpecialB && !EXCLUDE_B_COMMON.includes(a)) ? COMMON_CATEGORY : a;

            const results = APP_DATA.main.slice(1).filter(r => r[0] === effA && r[1] === b && r[2] === l);
            displayResults({ headers: APP_DATA.main[0], results: results });
        }

        // 5. é¡¯ç¤ºä»£ç¢¼æ¸…å–® (ä¸éœ€å†ç™¼ API)
        function showCodeList() {
            const btn = document.getElementById('show_code_button');
            const res = document.getElementById('code_list_results');
            if (res.style.display === 'block') {
                res.style.display = 'none';
                btn.textContent = 'æŸ¥çœ‹16æ¡ˆä»¶å¥ä¿ç”³å ±ä»£ç¢¼';
                return;
            }
            res.style.display = 'block';
            btn.textContent = 'éš±è—16æ¡ˆä»¶å¥ä¿ç”³å ±ä»£ç¢¼';
            let html = '<div><p style="font-weight: bold; color: #16a085; margin-bottom: 15px;">æœªæ¶µè“‹é …ç›®äº¦å¯ç”³å ±ï¼Œä½†è«‹æ³¨æ„èº«ä»½æ˜¯å¦ç¬¦åˆ</p>';
            html += renderTable(APP_DATA.codeList.headers, APP_DATA.codeList.results);
            html += renderCardList(APP_DATA.codeList.headers, APP_DATA.codeList.results);
            html += '</div>';
            res.innerHTML = html;
        }

        // --- ä»¥ä¸‹ç‚ºé€šç”¨è¼”åŠ©å‡½æ•¸ ---

        function updateSelectOptions(id, opts, placeholder) {
            const s = document.getElementById(id);
            s.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            opts.forEach(opt => { const o = document.createElement('option'); o.value = o.text = opt; s.appendChild(o); });
            s.disabled = false;
        }

        function resetSelect(id, placeholder) {
            const s = document.getElementById(id);
            s.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            s.disabled = true;
        }

        function resetQueryState() {
            document.getElementById('query_button').disabled = true;
            document.getElementById('results').innerHTML = 'è«‹åœ¨ä¸Šæ–¹é¸æ“‡æŸ¥è©¢æ¢ä»¶å¾Œé»æ“ŠæŸ¥è©¢ã€‚';
        }

        function enableQueryButton() { document.getElementById('query_button').disabled = false; }

        function processLineBreaks(v) { return v ? String(v).replace(/\s*\[BR\]\s*/gi, '<br>').trim() : ''; }
        function processRawValue(v) { return v ? String(v).trim() : ''; }

        function displayResults(response) {
            const resultsDiv = document.getElementById('results');
            if (!response.results || response.results.length === 0) {
                resultsDiv.innerHTML = '<p class="no-result">âš ï¸ æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</p>';
                return;
            }
            let html = '';
            response.results.forEach(row => {
                html += '<table class="result-table">';
                response.headers.forEach((h, i) => {
                    if (i >= 3 && row[i] !== '') {
                        const val = h.includes('å‚™è¨»') ? processLineBreaks(row[i]) : processRawValue(row[i]);
                        html += `<tr><th>${h}</th><td>${val}</td></tr>`;
                    }
                });
                html += '</table><br>';
            });
            resultsDiv.innerHTML = html;
        }

        function renderTable(headers, rows) {
            let h = '<table class="desktop-table"><thead><tr>';
            headers.forEach(txt => h += `<th>${txt}</th>`);
            h += '</tr></thead><tbody>';
            rows.forEach(row => {
                h += '<tr>';
                row.forEach((cell, i) => {
                    const val = headers[i].includes('å‚™è¨»') ? processLineBreaks(cell) : processRawValue(cell);
                    h += `<td>${val}</td>`;
                });
                h += '</tr>';
            });
            return h + '</tbody></table>';
        }

        function renderCardList(headers, rows) {
            let h = '<ul class="mobile-card-list">';
            rows.forEach((row, idx) => {
                h += `<li class="mobile-card"><h4>${processRawValue(row[0]) || 'é …ç›®'}</h4>`;
                for (let i = 1; i < headers.length; i++) {
                    const val = headers[i].includes('å‚™è¨»') ? processLineBreaks(row[i]) : processRawValue(row[i]);
                    if (val) h += `<div class="mobile-field-row"><span class="mobile-field-title">${headers[i]}:</span><div class="mobile-field-content">${val}</div></div>`;
                }
                h += '</li>';
            });
            return h + '</ul>';
        }

        function clearAppData() {
            localStorage.removeItem(CACHE_KEY);
            alert('å¿«å–å·²æ¸…é™¤ï¼Œæ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...');
            location.reload();
        }
    </script>
</body>
</html>
